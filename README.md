# Karabo-Feedstock<a id="feedstock"></a>

This repository builds the conda-dependencies for the [Karabo pipeline](https://github.com/i4Ds/Karabo-Pipeline) so that conda-wheel of the pipeline can be built. To do this, the individual packages must be triggered by `build * dependenc(y/ies) *` workflows, which orchestrate other workflows located in this repository. Since the number of workflows to be called is limited to 20 by GitHub, the whole process can unfortunately not be handled in a single workflow. There are three different kind of builds to consider: *Main builds* & *Dev builds*.

**Note**: The builds of the feedstock are from 3th party repositories or forked repositories to make them compatible with the Karabo pipeline. This means that the respective builds do not have correct dpendency resolvements because we cannot test this properly. So the main goal is to make sure that the builds related to a Karabo installation have a correct dependency resolvement. If the constraints of a build are too tight or too loose, we can correct this. We ask to open an issue in such a case.

**Attention for devs:** The conda build-string (to distinguish whether to overwrite an existing wheel or not) is dependent on the version string and python version. So changing the label only doesn't change the bulid string and that could overwrite an existring conda wheel.

## Main builds
Main builds are Conda wheels which are needed for a Karabo build. These packages should have the `main` label, so that they can be installed without additional referencing of another channel. If the release number is greater than previous releases, the package automatically becomes `latest`.

## Dev builds
Dev builds are Conda wheels, which are used for development purpose (e.g. build new version of a package), but should not appear under `latest`. The naming convention is [PEP 440](https://peps.python.org/pep-0440/) compliant: `{MAJOR}.{MINOR}.dev{PATCH}`, which is automatically formed this way if the `dev` flag is set when starting a workflow. The current setup calls for the builds to have the `main` label as well. This must be compatible with the [environment.yaml](https://github.com/i4Ds/Karabo-Pipeline/blob/main/environment.yaml) of the Karabo pipeline, where they can easily be referenced.

Dev-builds can have other conda-dependencies which are also part of the Feedstock. In case you need a newer version of such a sub-dependency, they should also be a dev-build, to not create a `lates` wheel which could interfere with existing karabo wheels. In case you want to refer to such dev-builds, there is a `devDeps` option for each build which has such possible dependencies. To refer to dev-sub-dependencies, you can modify the `devDeps` option. If such an option is available, the names of each sub-dependency is comma separated (e.g. `{dep1}, {dep2}, {dep3}`) followed by a whitespace. The `dep` name must be a `build_base.yml env.{dep}` name where in the version string dev must NOT occur. The default value is to refer all sub-dependencies as dev-dependencies. *Note*: `devDeps` is only active if the `dev` flag is set, otherwise it has no effect.

The setup relies on `packageVersionNames` in `build_base.yml`. To make the dev-setup work, you should use an `_ALT` suffix of the `packageVersionNames` in the `meta.yaml`. They have the according dev-version if specified. However, don't use them everywhere, e.g. not when you are doing a checkout on a version of a git-repo. Just think about where you might want to have the dev-versionings and where not.

## Tree builds
Tree builds usually have a `tree` keyword in the workflow. These are a special kind of builds, where a new build is dependent on other dependencies we build as well. The tree builds therefore build the whole dependency tree in a single super-workflow. In case a dev-tree-build is triggered setting the `dev` flag, each underlying sub-dependency is automatically considered to be a dev-build. An option allowing a mix between dev and non-dev builds of tree-builds is not implemented. Therefore, tree-builds shouldn't have a `devDeps` option.

## Version number management
(not dev) of the packages to be built is usually handled by the `build base (build_base.yml)` super-workflow. In it, the versions of the packages can be updated to a newer version. **Important:** There are some packages where version changes also require adjustments in the `conda build-recipe`, for example in `meta.yaml`. In it can be e.g. fixed git-tag/rev or dependencies, which do not correspond any more with the updated version of the package to be built. The individual builds with version changes must be tested beforehand, before going into a Karabo release.
